<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <title>结算页</title>
    <link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css"/>
    <link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css"/>
    <link rel="stylesheet" href="/commons/js/bootstrap-3.3.7-dist/bootstrap-3.3.7-dist/css/bootstrap.min.css"
          type="text/css">
</head>

<body>
<!--head-->
<div class="top">
    <div class="py-container">
        <div class="shortcut">
            <ul class="fl">
                <li class="f-item">品优购欢迎您！</li>
                <li class="f-item">请登录　<span><a href="#">免费注册</a></span></li>
            </ul>
            <ul class="fr">
                <li class="f-item">我的订单</li>
                <li class="f-item space"></li>
                <li class="f-item">我的品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">品优购会员</li>
                <li class="f-item space"></li>
                <li class="f-item">企业采购</li>
                <li class="f-item space"></li>
                <li class="f-item">关注品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">客户服务</li>
                <li class="f-item space"></li>
                <li class="f-item">网站导航</li>
            </ul>
        </div>
    </div>
</div>
<div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">
            <form class="sui-form form-inline">
                <div class="input-append">
                </div>
            </form>
        </div>
    </div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>


        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息<span><a href="#" onclick="openadd()">新增收货地址</a></span></h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item" id="recipients">

                            <!--  <div>
                                  <div class="con name selected"><a href="javascript:;" >张默<span title="点击取消选择">&nbsp;</span></a></div>
                                  <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span>
                                      <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
                                  </div>
                                  <div class="clearfix"></div>
                              </div>-->
                        </li>
                    </ul>
                    <!--确认地址-->
                </div>
                <div class="hr"></div>
            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected">微信付款<span title="点击取消选择"></span></li>
                        <li>货到付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont">
                    <ul class="send-detail" id="cartsdata">

                        <!--<li>
                            <div class="sendGoods">
                                <ul class="yui3-g">
                                    <li class="yui3-u-1-6">
                                        <span><img src=""/></span>
                                    </li>
                                    <li class="yui3-u-7-12">
                                        <div class="desc">Apple iPhone 6s (A1700) 64G 玫瑰金色 移动联通电信4G手机硅胶透明防摔软壳 本色系列</div>
                                        <div class="seven">7天无理由退货</div>
                                    </li>
                                    <li class="yui3-u-1-12">
                                        <div class="price">￥5399.00</div>
                                    </li>
                                    <li class="yui3-u-1-12">
                                        <div class="num">X1</div>
                                    </li>
                                    <li class="yui3-u-1-12">
                                        <div class="exit">有货</div>
                                    </li>
                                </ul>
                            </div>
                        </li>-->


                    </ul>
                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary">
        <div class="static fr">
            <div class="list">
                <span><i class="number" id="count"></i>件商品，总商品金额</span>
                <em class="allprice" id="smalltotal"></em>
            </div>
            <div class="list">
                <span>返现：</span>
                <em class="money">0.00</em>
            </div>
            <div class="list">
                <span>运费：</span>
                <em class="transport">0.00</em>
            </div>
        </div>
    </div>
    <div class="clearfix trade">
        <div class="fc-price">应付金额:　<span class="price" id="bigtotal"></span></div>
        <div class="fc-receiverInfo" id="ordermenu"></div>
    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" href='#' onclick="submitorder()">提交订单</a>
    </div>
</div>


<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--页面底部END-->
<script type="text/javascript" src="/commons/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="/commons/js/bootstrap-3.3.7-dist/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/commons/bootbox/bootbox.min.js"></script>
<script type="text/javascript" src="/commons/bootbox/bootbox.locales.min.js"></script>
<!--<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>-->
<!--<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>-->
<script>
    var token = document.cookie;
    var addbootbox;
    var updatebootbox;
    var addbootboxhtml;
    var updatebootboxhtml;
    $(function () {
        initajaxSetup();  //设置ajax后置通知
        initrecipients(); //拼接收件人
        initcarts();  //拼接购物车
        copyhmtl();
        copyupdatehtml();
    })
    var orderino = "";
    var orderinfo;

    function initrecipients() {
        $("#recipients").html("");
        $.post({
            url: "http://localhost:8086/order/initaddress",
            dataType: "json",
            beforeSend: function (request) {
                request.setRequestHeader("token", token);
            },
            success: function (data) {
                if (data.code == 200) {
                    orderinfo = data.data;
                    for (var i = 0; i < orderinfo.length; i++) {
                        if (i == 0) {
                            orderino += "<div>\n" +
                                " <div class=\"con name selected\"><a href='#' onclick='checkrecipient(" + orderinfo[i].id + ")'>" + orderinfo[i].recipientsname + "<span title=\"点击取消选择\"></span>&nbsp;</a>\n" +
                                "</div>\n" +
                                " <div class=\"con address\">" + orderinfo[i].recipientsname + "   " + orderinfo[i].addressname + " <span>" + orderinfo[i].recipientsphone + "</span>\n" +
                                " <span class=\"base\">默认地址</span>\n" +
                                " <a href='#' onclick='updaterecipients(" + orderinfo[i].id + ")'>编辑</a>&nbsp;&nbsp;<a\n" +
                                "href='#' onclick='deleterecipients(" + orderinfo[i].id + ")'>删除</a>\n" +
                                "</div>\n" +
                                " <div class=\"clearfix\"></div>\n" +
                                " </div>\n"
                            $("#ordermenu").html("寄送至:" + orderinfo[i].addressname + "       " +
                                "收货人：" + orderinfo[i].recipientsname + "           " + orderinfo[i].recipientsphone + "")
                        } else {
                            orderino += "<div>\n" +
                                " <div class=\"con name selected\"><a href=\"#\" onclick='checkrecipient(" + orderinfo[i].id + ")'>" + orderinfo[i].recipientsname + "&nbsp;</a>\n" +
                                "</div>\n" +
                                " <div class=\"con address\">" + orderinfo[i].recipientsname + "   " + orderinfo[i].addressname + " <span>" + orderinfo[i].recipientsphone + "</span>\n" +
                                "  <span ><a href='#' onclick='updaterecipients(" + orderinfo[i].id + ")'>编辑</a>&nbsp;&nbsp;<a\n" +
                                "href='#' onclick='deleterecipients(" + orderinfo[i].id + ")'>删除</a></span>\n" +
                                "</div>\n" +
                                " <div class=\"clearfix\"></div>\n" +
                                " </div>\n"
                        }

                    }
                    $("#recipients").html(orderino);
                    orderino = "";

                }
            }
        })
    }

    var cartdatas = "";

    function initcarts() {
        $.post({
            url: "http://localhost:8085/cart/querycarts",
            dataType: "json",
            beforeSend: function (request) {
                request.setRequestHeader("token", token);
            },
            success: function (data) {
                if (data.code == 200) {
                    //拼接选中并且有货的购物车数据
                    var data = data.data;
                    var cartdata = data.cartdata;
                    var cartcount = data.cartcount;
                    var total = data.total;
                    for (var i = 0; i < cartdata.length; i++) {
                        cartdatas += "<li>\n" +
                            "<div class=\"sendGoods\">\n" +
                            "<ul class=\"yui3-g\">\n" +
                            "<li class=\"yui3-u-1-6\">\n" +
                            "<span><img src=" + cartdata[i].shopimg + "/></span>\n" +
                            " </li>\n" +
                            "<li class=\"yui3-u-7-12\">\n" +
                            "<div class=\"desc\">" + cartdata[i].shopname + "</div>\n" +
                            "<div class=\"seven\">7天无理由退货</div>\n" +
                            " </li>\n" +
                            "<li class=\"yui3-u-1-12\">\n" +
                            " <div class=\"price\">" + cartdata[i].subtotal + "</div>\n" +
                            " </li>\n" +
                            "<li class=\"yui3-u-1-12\">\n" +
                            " <div class=\"num\">X" + cartdata[i].count + "</div>\n" +
                            "</li>\n" +
                            "<li class=\"yui3-u-1-12\">\n" +
                            " <div class=\"num\">有货</div>\n" +
                            "</li>" +
                            " </ul>\n" +
                            "</div>\n" +
                            "</li>";
                    }
                    $("#cartsdata").html(cartdatas);
                    cartdatas = "";
                    $("#count").html(cartcount);
                    $("#smalltotal").html(total);
                    $("#bigtotal").html(total);
                }
            }
        })
    }

    //点击更换收件人
    function checkrecipient(recipientid) {
        $.post({
            url: "http://localhost:8086/order/checkrecipient",
            dataType: "json",
            data: {"recipientid": recipientid},
            beforeSend: function (request) {
                request.setRequestHeader("token", token);
            },
            success: function (data) {
                if (data.code == 200) {
                    initrecipients();
                    var newrecipients = data.data;
                    $("#ordermenu").html("寄送至:" + newrecipients.addressname + "" +
                        "收货人：" + newrecipients.recipientsname + "" + newrecipients.recipientsphone + "")
                }
            }
        })
    }

    //增加收件人
    function openadd() {
        $("#addDiv").html(addbootboxhtml);
        addbootbox = bootbox.dialog({
            title: '收件人增加',
            message: $("#addDiv form"),
            size: 'large',
            buttons: {
                ok: {
                    label: "提交",
                    className: 'btn-info',
                    callback: function () {
                        var recipientsname = $("#add_recipientsname", addbootbox).val();
                        var addressname = $("#add_addressname", addbootbox).val();
                        var phone = $("#add_phone", addbootbox).val();
                        var email = $("#add_email", addbootbox).val();
                        var data = {};
                        data.addressname = addressname;
                        data.recipientsname = recipientsname;
                        data.recipientsphone = phone;
                        data.email = email;
                        $.post({
                            url: "http://localhost:8086/order/addrecipients",
                            data: data,
                            dataType: "json",
                            beforeSend: function (request) {
                                request.setRequestHeader("token", token);
                            },
                            success: function (data) {
                                if (data.code == 200) {
                                    initrecipients();
                                }
                            }
                        })
                    },
                },
                cancel: {
                    label: "关闭",
                    className: 'btn-danger',
                    callback: function () {

                    }
                }
            },
        });
    }

    //编辑
    function updaterecipients(recipientsid) {
        $.post({
            url: "http://localhost:8086/order/echorecipients",
            dataType: "json",
            data: {"recipientsid": recipientsid},
            beforeSend: function (request) {
                request.setRequestHeader("token", token);
            },
            success: function (data) {
                if (data.code == 200) {
                    var recipientsdata = data.data;
                    $("#up_recipientsname").val(recipientsdata.recipientsname);
                    $("#up_addressname").val(recipientsdata.addressname);
                    $("#up_phone").val(recipientsdata.recipientsphone);
                    $("#up_email").val(recipientsdata.email);
                    updatebootbox = bootbox.dialog({
                        title: '收件人修改',
                        message: $("#updateDiv form"),
                        size: 'large',
                        buttons: {
                            ok: {
                                label: "提交",
                                className: 'btn-info',
                                callback: function () {
                                    var v_recipientsname = $("#up_recipientsname", updatebootbox).val();
                                    var v_addressname = $("#up_addressname", updatebootbox).val();
                                    var v_up_phone = $("#up_phone", updatebootbox).val();
                                    var v_email = $("#up_email", updatebootbox).val();
                                    var v_id = recipientsdata.id;
                                    var data = {};
                                    data.addressname = v_addressname;
                                    data.recipientsname = v_recipientsname;
                                    data.recipientsphone = v_up_phone;
                                    data.email = v_email;
                                    data.id = v_id;
                                    $.post({
                                        url: "http://localhost:8086/order/updaterecipients",
                                        dataType: "json",
                                        data: data,
                                        beforeSend: function (request) {
                                            request.setRequestHeader("token", token);
                                        },
                                        success: function (data) {
                                            if (data.code == 200) {
                                                initrecipients();
                                            }
                                        }
                                    })
                                },
                            },
                            cancel: {
                                label: "关闭",
                                className: 'btn-danger',
                                callback: function () {

                                }
                            }
                        },
                    });
                    $("#updateDiv").html(updatebootboxhtml);
                }
            }
        })
    }


    //删除收件人
    function deleterecipients(recipientsid) {
        bootbox.confirm({
            title: "删除",
            message: "你确认要删除吗?",
            buttons: {
                cancel: {
                    label: '<i class="fa fa-times"></i> 取消'
                },
                confirm: {
                    label: '<i class="fa fa-check"></i> 确定'
                }
            },
            callback: function (result) {
                if (result) {
                    $.post({
                        url: "http://localhost:8086/order/deleterecipients",
                        dataType: "json",
                        data: {"recipientsid": recipientsid},
                        beforeSend: function (request) {
                            request.setRequestHeader("token", token);
                        },
                        success: function (data) {
                            if (data.code == 200) {
                                initrecipients();
                            }
                        }
                    })
                }
            }
        })
    }


    //申请订单
    function submitorder() {
        var checkrecipientsid;
        for (var i = 0; i < orderinfo.length; i++) {
            if (i == 0) {
                checkrecipientsid = orderinfo[i].id;
            }
        }
        $.post({
            url: "http://localhost:8087/ROrder/addrorder",
            dataType: "json",
            data: {"recipientsid": checkrecipientsid},
            beforeSend: function (request) {
                request.setRequestHeader("token", token);
            },
            success: function (data) {
                if (data.code == 200) {
                    var alldata = data.data;
                    var nostocklist = alldata.nostocklist; //库存不足的商品
                    var orderid = alldata.orderid;
                    var outTradeNo = alldata.outTradeNo;
                    sessionStorage.setItem("orderid", orderid);
                    sessionStorage.setItem("outTradeNo", outTradeNo);
                    if (nostocklist.length > 0) {
                        var nostockname = "";
                        for (var i = 0; i < nostocklist.length; i++) {
                            nostockname += nostocklist[i].shopname + ";  ";
                        }
                        bootbox.alert("抱歉,你提交的订单中有存在库存不足的商品数据：" + nostockname, function () {
                            location.href = "pay-student.html";
                        });
                    }

                }
            }
        })
    }

    //页面加载：设置全局ajax请求后的执行动作
    function initajaxSetup() {
        $.ajaxSetup({
            complete: function (resultt) {
                var result = resultt.responseJSON;
                if (result.code && result.code != 200) {
                    bootbox.alert({
                        message: result.msg,
                        size: 'small'
                    });
                }
                if (result.code == 1009) {
                    location.href = "login.html";
                }
            }
        });
    }

    function copyhmtl() {
        addbootboxhtml = $("#addDiv").html();
    }

    function copyupdatehtml() {
        updatebootboxhtml = $("#updateDiv").html();
    }
</script>
<!--bootbox增加信息框中的表单-->
<div id="addDiv" style="display: none;">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">收货人</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入收货人..." id="add_recipientsname">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">详细地址</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入详细地址..." id="add_addressname">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">联系电话</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入联系电话..." id="add_phone">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">邮箱</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入邮箱..." id="add_email">
            </div>
        </div>
    </form>
</div>


<!--bootbox修改信息框中的表单-->
<div id="updateDiv" style="display: none;">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">收货人</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入收货人..." id="up_recipientsname">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">详细地址</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入详细地址..." id="up_addressname">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">联系电话</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入联系电话..." id="up_phone">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">邮箱</label>
            <div class="col-sm-4">
                <input type="email" class="form-control" placeholder="请输入邮箱..." id="up_email">
            </div>
        </div>
    </form>
</div>
</body>
</html>